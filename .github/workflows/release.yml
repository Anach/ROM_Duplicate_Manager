name: Build and Release
on:
  push:
    tags: ['v*']

env:
  APP_NAME: ROM.Duplicate.Manager
  
jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
            extension: .exe
            archive: zip
          - os: ubuntu-latest
            platform: linux  
            extension: .AppImage
            archive: tar.gz
          - os: macos-latest
            platform: macos
            extension: .app
            archive: tar.gz
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Get version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "clean_version=${VERSION//[^0-9.]/}" >> $GITHUB_OUTPUT
      shell: bash
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build Windows EXE
      if: matrix.platform == 'win'
      run: |
        pyinstaller --onefile --windowed --name="${{ env.APP_NAME }}" rom_duplicate_manager.py
        
    - name: Build Linux AppImage  
      if: matrix.platform == 'linux'
      run: |
        pyinstaller --onefile --name="${{ env.APP_NAME }}" rom_duplicate_manager.py
        # TODO: Add AppImage creation steps
        
    - name: Build macOS App
      if: matrix.platform == 'macos'
      run: |
        pyinstaller --onefile --windowed --name="${{ env.APP_NAME }}" rom_duplicate_manager.py
        # TODO: Create .dmg from .app bundle
    
    - name: Create release archive
      id: archive
      run: |
        VERSION="${{ steps.version.outputs.clean_version }}"
        PLATFORM="${{ matrix.platform }}"
        
        # Create standardized filename
        if [ "${{ matrix.platform }}" = "win" ]; then
          FILENAME="${{ env.APP_NAME }}.v.$VERSION.zip"
          ARCHIVE_CMD="7z a"
        elif [ "${{ matrix.platform }}" = "linux" ]; then
          FILENAME="${{ env.APP_NAME }}.v.$VERSION.linux.tar.gz"
          ARCHIVE_CMD="tar -czf"
        else
          FILENAME="${{ env.APP_NAME }}.v.$VERSION.macos.tar.gz"
          ARCHIVE_CMD="tar -czf"
        fi
        
        # Create release directory
        mkdir -p release
        
        # Copy executable
        if [ "${{ matrix.platform }}" = "win" ]; then
          cp "dist/${{ env.APP_NAME }}.exe" release/
        elif [ "${{ matrix.platform }}" = "linux" ]; then
          cp "dist/${{ env.APP_NAME }}" release/
          mv "release/${{ env.APP_NAME }}" "release/${{ env.APP_NAME }}.AppImage"
        else
          cp -r "dist/${{ env.APP_NAME }}.app" release/ || cp "dist/${{ env.APP_NAME }}" release/
        fi
        
        # Copy documentation
        cp README.md release/
        cp CHANGELOG.md release/ 
        cp LICENSE release/
        
        # Create version info file
        echo "Version: $VERSION" > release/VERSION.txt
        echo "Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> release/VERSION.txt
        echo "Platform: ${{ matrix.platform }}" >> release/VERSION.txt
        echo "Git Commit: ${{ github.sha }}" >> release/VERSION.txt
        
        # Create archive
        cd release
        if [ "${{ matrix.platform }}" = "win" ]; then
          7z a "../$FILENAME" *
        else
          tar -czf "../$FILENAME" *
        fi
        cd ..
        
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        echo "filepath=$PWD/$FILENAME" >> $GITHUB_OUTPUT
      shell: bash
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: ${{ steps.archive.outputs.filename }}
        path: ${{ steps.archive.outputs.filepath }}
  
  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts
    
    - name: Get version  
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Generate checksums
      run: |
        cd artifacts
        find . -name "*.zip" -o -name "*.tar.gz" | xargs sha256sum > SHA256SUMS
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "ROM Duplicate Manager v${{ steps.version.outputs.version }}"
        body_path: CHANGELOG.md
        files: |
          artifacts/**/*.zip
          artifacts/**/*.tar.gz
          artifacts/SHA256SUMS
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}